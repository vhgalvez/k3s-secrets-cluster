# playbooks\run_all_secrets_pipeline.yml
---
- name: 🚀 Ejecuta todo el flujo completo de secretos (full pipeline)
  hosts: localhost
  become: true
  gather_facts: false

  tasks:
    - name: 🛠️ Instalar kubeseal en localhost
      include_playbook: 00_setup_kubeseal.yml

    - name: 🚀 Despliega el controller de Sealed Secrets en el clúster
      include_playbook: 01_deploy_sealed_secrets.yml

    - name: 📝 Genera archivos YAML base desde variables (secrets planos)
      include_playbook: 02_generate_secret_templates.yml

    - name: 🔐 Renderiza plantillas Jinja2 y las cifra con kubeseal
      include_playbook: 03_render_and_seal_secrets.yml

    - name: 🔐 Crea secretos con autenticación básica htpasswd
      include_playbook: 04_generate_htpasswd_secrets.yml
      when: htpasswd_enabled | default(false)

    - name: 🔐 Sella archivos YAML ya generados manualmente
      include_playbook: 05_seal_existing_yaml.yml
      when: manual_sealing_enabled | default(false)